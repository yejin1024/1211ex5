pipeline {
    agent any

    environment {
        JMETER_HOME_WIN = "C:\\Users\\josun\\Desktop\\alice_track\\apache-jmeter-5.6.3"
        JMETER_HOME_UNIX = "/.../apache-jmeter-5.6.3"
    }

    stages {
        stage('Checkout JMX from GitHub') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/yejin1024/1211ex5.git'
            }
        }

        stage('Find JMX File') {
            steps {
                script {
                    def jmxFile = ""
        
                    if (isUnix()) {
                        jmxFile = sh(
                            script: "ls *.jmx 2>/dev/null | head -n 1",
                            returnStdout: true
                        ).trim()
                    } else {
                        def output = bat(
                            script: '@for %%f in (*.jmx) do @echo %%f',
                            returnStdout: true
                        ).trim()
                        
                        def lines = output.split('\n')
                        jmxFile = lines[-1].trim()
                    }
        
                    if (!jmxFile) {
                        error "❌ No .jmx file found in workspace!"
                    }
        
                    echo "✔ Found JMX file: ${jmxFile}"
                    env.JMX_FILE = jmxFile
                }
            }
        }

        stage('Run Performance Test') {
            steps {
                script {
                    def isWindows = !isUnix()
                    echo "=== Performance Test Start ==="
                    echo "Running on Windows? ${isWindows}"
                    echo "JMX File: ${env.JMX_FILE}"
                    echo "JMeter Home: ${env.JMETER_HOME_WIN}"
                    
                    if (isWindows) {
                        // JMeter 경로 확인
                        bat """
                            @echo off
                            echo Checking JMeter installation...
                            if exist "${env.JMETER_HOME_WIN}\\bin\\jmeter.bat" (
                                echo [OK] JMeter found
                            ) else (
                                echo [ERROR] JMeter not found at: ${env.JMETER_HOME_WIN}
                                exit /b 1
                            )
                        """
                        
                        // 이전 결과 삭제
                        bat "if exist results.jtl del /F /Q results.jtl"
                        bat "if exist reports rmdir /S /Q reports"
                        
                        // JMeter 실행
                        echo "Executing JMeter test..."
                        bat """
                            @echo off
                            echo Starting JMeter with file: ${env.JMX_FILE}
                            cd /d "%CD%"
                            "${env.JMETER_HOME_WIN}\\bin\\jmeter.bat" -n -t "${env.JMX_FILE}" -l results.jtl -e -o reports
                            set EXIT_CODE=%ERRORLEVEL%
                            echo JMeter finished with exit code: %EXIT_CODE%
                            exit /b %EXIT_CODE%
                        """
                        
                        echo "JMeter test completed successfully!"
                    } else {
                        sh "rm -f results.jtl"
                        sh "rm -rf reports"
                        
                        sh """
                            ${env.JMETER_HOME_UNIX}/bin/jmeter.sh -n \\
                              -t "${env.JMX_FILE}" \\
                              -l results.jtl \\
                              -e -o reports
                        """
                    }
                }
            }
        }

        stage('Publish Performance Report') {
            steps {
                perfReport(
                     sourceDataFiles: 'results.jtl',
                     parsers: [
                         [$class: 'JMeterParser', glob: 'results.jtl']
                     ]
                 )
            }
        }

        stage('Archive Results') {
            steps {
                archiveArtifacts artifacts: 'results.jtl', allowEmptyArchive: true
                archiveArtifacts artifacts: 'reports/**', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo "Pipeline finished."
        }
        success {
            echo "✔ Pipeline completed successfully!"
        }
        failure {
            echo "✖ Pipeline failed. Check logs above."
        }
    }
}
